
var app = require('express')();
var http = require('http').Server(app);
var io = require('socket.io')(http);
var userData = [];
var count = 0;

app.get('/', function(req, res){res.sendFile(__dirname +'/index.html');});
app.get('/jquery.js', function(req,res){res.sendFile(__dirname + '/jquery.js');});
app.get('/chat.js', function(req,res){res.sendFile(__dirname + '/js/chat.js');});
app.get('/chatAppController.js', function(req,res){res.sendFile(__dirname + '/js/chatAppController.js');});
app.get('/angular.js', function(req,res){res.sendFile(__dirname + '/js/angular.js');});
app.get('/angular.min.js.map', function(req,res){res.sendFile(__dirname + '/js/angular.min.js.map');});
app.get('/site.js', function(req,res){res.sendFile(__dirname + '/js/site.js');});
app.get('/site.css', function(req,res){res.sendFile(__dirname + '/css/site.css');});
app.get('/bootstrap.css', function(req,res){res.sendFile(__dirname + '/css/bootstrap.min.css');});



io.on('connection', function(socket){
  socket.on('chatMessage', function(data){
  	var userID = data.UserID;
  	var msg = data.Message;
  	var username = userData[userID]['Username'];
    io.emit('chatMessage', username+': ' + msg);
  });

  socket.on('login', function(data){
    var fName = data.firstName;
    var lName = data.lastName;
    var initials = data.initials;
    var dpColor = data.dpColor;
    var uID = findUsername(fName, lName);
    if(uID===true){
      count++;
      userData[count] = {'firstName':fName, 'lastName':lName,'initials':initials, 'dpColor':dpColor, 'SessionStatus':1};
      socket.emit('callBackLogin', {'UserID':count, 'UserLists':userData});
      socket.broadcast.emit('broadCastNewUsers', userData[count]);
    }else{
      io.emit('callBackLogin', {'UserID':uID, 'UserLists':userData});
      socket.broadcast.emit('broadCastNewUsers', userData[uID]);
    }
  	console.log(userData);
  });

  function findUsername(firstName, lastName){
    var returnValue=true;
    for(var i=1;i<=count;i++){
      var data = userData[i];
      returnValue = (data['firstName']==firstName && data['lastName']==lastName)?i:true;
      break;
    }
    return returnValue;
  }

});


http.listen(3000, function(){
  console.log('listening on *:3000');
});

